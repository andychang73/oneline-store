<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.abstractionizer.Hello.World.storage.rmdb.mapper.SalesOrderMapper">

    <insert id="insertEntity" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sales_order (customer_id, total) VALUES (#{customerId}, #{total})
    </insert>

    <resultMap id="SalesDetailsVo" type="com.abstractionizer.Hello.World.model.vo.SalesDetailsVo">
        <id column="orderId" property="orderId" jdbcType="BIGINT"/>
        <result column="total" property="total" jdbcType="DECIMAL"/>
        <result column="date" property="date" jdbcType="TIMESTAMP"/>
        <collection property="productDetails" ofType="com.abstractionizer.Hello.World.model.vo.ProductDetailsVo">
            <result column="productId" property="productId" jdbcType="BIGINT"/>
            <result column="productName" property="productName" jdbcType="VARCHAR"/>
            <result column="quantity" property="quantity" jdbcType="INTEGER"/>
            <result column="price" property="price" jdbcType="DECIMAL"/>
            <result column="subTotal" property="subTotal" jdbcType="DECIMAL"/>
        </collection>
    </resultMap>

    <select id="selectByOrderIdOrProductNameOrCreatedAt" resultMap="SalesDetailsVo">
        SELECT o.id AS orderId, o.total, o.created_at AS date, d.product_id AS productId,
                d.product_name AS productName, d.quantity, d.price, d.sub_total AS subTotal
        FROM sales_order o
        JOIN sales_order_detail d ON d.sales_order_id = o.id
        <where>
            <if test="customerId != null">
                AND o.customer_id = #{customerId}
            </if>
            <if test="orderId != null">
                AND o.id = #{orderId}
            </if>
            <if test="productName != null and productName != ''">
                AND d.product_name = #{productName}
            </if>
            <if test="from != null">
                AND  created_at &gt;= #{from}
            </if>
            <if test="to != null">
                AND created_at &lt;= #{to}
            </if>
        </where>
        ORDER BY created_at DESC
    </select>
</mapper>